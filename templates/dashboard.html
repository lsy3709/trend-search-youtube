<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>íŠ¸ë Œë“œ í‚¤ì›Œë“œ ëŒ€ì‹œë³´ë“œ</title>
    <link rel="stylesheet" href="/static/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <h1>íŠ¸ë Œë“œ í‚¤ì›Œë“œ ëŒ€ì‹œë³´ë“œ</h1>
    
    <!-- ì‹¤ì‹œê°„ ì¸ê¸° ê²€ìƒ‰ì–´ ì„¹ì…˜ -->
    <div class="trending-section">
        <h2>ğŸ”¥ ì‹¤ì‹œê°„ ì¸ê¸° ê²€ìƒ‰ì–´</h2>
        <div id="trending-keywords" class="trending-keywords">
            <p>ë¡œë”© ì¤‘...</p>
        </div>
        <button onclick="loadTrendingKeywords()" class="refresh-btn">ìƒˆë¡œê³ ì¹¨</button>
    </div>
    
    <!-- í‚¤ì›Œë“œ ì…ë ¥ í¼ -->
    <div class="search-section">
        <h2>ğŸ” í‚¤ì›Œë“œ ê²€ìƒ‰</h2>
        <form method="get" action="/web">
            <input type="text" name="keyword" value="{{ keyword }}" placeholder="í‚¤ì›Œë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”" required>
            <button type="submit">ê²€ìƒ‰</button>
        </form>
    </div>
    
    <!-- ì—°ë ¹ëŒ€ë³„ í‚¤ì›Œë“œ ë¶„ì„ ì„¹ì…˜ -->
    <div class="age-analysis-section">
        <h2>ğŸ‘¥ ì—°ë ¹ëŒ€ë³„ í‚¤ì›Œë“œ ë¶„ì„</h2>
        <div class="age-analysis-controls">
            <button onclick="loadAgeGroupKeywords()" class="analysis-btn">ì—°ë ¹ëŒ€ë³„ í‚¤ì›Œë“œ ë¶„ì„</button>
            <button onclick="loadAgeGroupTrends()" class="analysis-btn">ì—°ë ¹ëŒ€ë³„ íŠ¸ë Œë“œ ë¶„ì„</button>
            <div class="keyword-input-group">
                <input type="text" id="keywordForAnalysis" placeholder="ë¶„ì„í•  í‚¤ì›Œë“œ ì…ë ¥">
                <button onclick="analyzeSpecificKeyword()" class="analysis-btn">í‚¤ì›Œë“œ ì—°ë ¹ëŒ€ ë¶„ì„</button>
            </div>
        </div>
        
        <!-- ì—°ë ¹ëŒ€ë³„ í‚¤ì›Œë“œ ê²°ê³¼ -->
        <div id="age-group-results" class="age-group-results">
            <p>ë¶„ì„ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ì—°ë ¹ëŒ€ë³„ í‚¤ì›Œë“œë¥¼ í™•ì¸í•˜ì„¸ìš”.</p>
        </div>
        
        <!-- ì—°ë ¹ëŒ€ë³„ íŠ¸ë Œë“œ ê²°ê³¼ -->
        <div id="age-trends-results" class="age-trends-results">
            <p>ë¶„ì„ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ì—°ë ¹ëŒ€ë³„ íŠ¸ë Œë“œë¥¼ í™•ì¸í•˜ì„¸ìš”.</p>
        </div>
        
        <!-- íŠ¹ì • í‚¤ì›Œë“œ ë¶„ì„ ê²°ê³¼ -->
        <div id="keyword-analysis-results" class="keyword-analysis-results">
            <p>í‚¤ì›Œë“œë¥¼ ì…ë ¥í•˜ê³  ë¶„ì„ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.</p>
        </div>
    </div>
    
    {% if error %}
        <div class="error">ì—ëŸ¬: {{ error }}</div>
    {% endif %}
    
    {% if keyword %}
    <div class="results-section">
        <h2>í‚¤ì›Œë“œ: <span style="color:blue">{{ keyword }}</span></h2>
        <h3>ì´ ê²€ìƒ‰ëŸ‰(ì¡°íšŒìˆ˜ í•©): {{ '{:,}'.format(total_views) }}</h3>
        
        <h3>ìƒìœ„ 10ê°œ íŠ¸ë Œë“œ(ì¡°íšŒìˆ˜ ê¸°ì¤€)</h3>
        <canvas id="trendChart" width="600" height="300"></canvas>
        <script>
            // ìƒìœ„ 10ê°œ íŠ¸ë Œë“œ ì°¨íŠ¸ ë°ì´í„° ì¤€ë¹„
            const labels = {{ top_trends | map(attribute='title') | list | tojson }};
            const data = {{ top_trends | map(attribute='view_count') | list | tojson }};
            new Chart(document.getElementById('trendChart'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ì¡°íšŒìˆ˜',
                        data: data,
                        backgroundColor: 'rgba(54, 162, 235, 0.5)'
                    }]
                },
                options: {
                    indexAxis: 'y',
                    plugins: { legend: { display: false } },
                    scales: { x: { beginAtZero: true } }
                }
            });
        </script>
        
        <h3>íŠ¸ë Œë“œ ë™ì˜ìƒ 100ê°œ</h3>
        <table>
            <thead>
                <tr>
                    <th>ì¸ë„¤ì¼</th>
                    <th>ì œëª©</th>
                    <th>ì‘ì„±ì</th>
                    <th>ì¡°íšŒìˆ˜</th>
                    <th>ì¢‹ì•„ìš”</th>
                    <th>ê²Œì‹œì¼</th>
                </tr>
            </thead>
            <tbody>
            {% for t in trends %}
                <tr>
                    <td>{% if t.thumbnail_url %}<img src="{{ t.thumbnail_url }}" width="80">{% endif %}</td>
                    <td><a href="{{ t.url }}" target="_blank">{{ t.title }}</a></td>
                    <td>{{ t.author }}</td>
                    <td>{{ '{:,}'.format(t.view_count or 0) }}</td>
                    <td>{{ '{:,}'.format(t.like_count or 0) }}</td>
                    <td>{{ t.published_at.strftime('%Y-%m-%d') if t.published_at else '' }}</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}
    
    <script>
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤ì‹œê°„ ì¸ê¸° ê²€ìƒ‰ì–´ ë¡œë“œ
        window.onload = function() {
            loadTrendingKeywords();
        };
        
        // ì‹¤ì‹œê°„ ì¸ê¸° ê²€ìƒ‰ì–´ ë¡œë“œ í•¨ìˆ˜
        async function loadTrendingKeywords() {
            try {
                const response = await fetch('/api/trends/keywords?max_results=20');
                const data = await response.json();
                
                const container = document.getElementById('trending-keywords');
                container.innerHTML = '';
                
                data.trending_keywords.forEach((item, index) => {
                    const keywordDiv = document.createElement('div');
                    keywordDiv.className = 'keyword-item';
                    keywordDiv.innerHTML = `
                        <span class="rank">${index + 1}</span>
                        <span class="keyword">${item.keyword}</span>
                        <span class="score">ğŸ”¥ ${item.trending_score}</span>
                        <span class="platforms">${item.platforms.join(', ')}</span>
                        <span class="views">ğŸ‘ï¸ ${(item.total_views / 1000).toFixed(0)}K</span>
                    `;
                    container.appendChild(keywordDiv);
                });
                
                // ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸ ì‹œê°„ í‘œì‹œ
                const updateTime = document.createElement('div');
                updateTime.className = 'update-time';
                updateTime.innerHTML = `ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ${new Date().toLocaleTimeString()}`;
                container.appendChild(updateTime);
                
            } catch (error) {
                console.error('ì¸ê¸° ê²€ìƒ‰ì–´ ë¡œë“œ ì‹¤íŒ¨:', error);
                document.getElementById('trending-keywords').innerHTML = 
                    '<p class="error">ì¸ê¸° ê²€ìƒ‰ì–´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
            }
        }
        
        // 5ë¶„ë§ˆë‹¤ ìë™ ìƒˆë¡œê³ ì¹¨
        setInterval(loadTrendingKeywords, 5 * 60 * 1000);
        
        // ì—°ë ¹ëŒ€ë³„ í‚¤ì›Œë“œ ë¶„ì„ ë¡œë“œ
        async function loadAgeGroupKeywords() {
            try {
                const response = await fetch('/api/age-analysis/keywords?max_results=15');
                const data = await response.json();
                
                const container = document.getElementById('age-group-results');
                container.innerHTML = '<h3>ì—°ë ¹ëŒ€ë³„ ì¸ê¸° í‚¤ì›Œë“œ</h3>';
                
                data.forEach(ageGroup => {
                    const ageDiv = document.createElement('div');
                    ageDiv.className = 'age-group';
                    ageDiv.innerHTML = `
                        <h4>${ageGroup.age_group} (íŠ¸ë Œë”© ì ìˆ˜: ${ageGroup.trending_score})</h4>
                        <div class="keywords-list">
                            ${ageGroup.keywords.map((kw, index) => `
                                <span class="keyword-tag ${kw.trending_level.replace(/\s+/g, '-').toLowerCase()}">
                                    ${index + 1}. ${kw.keyword} (${kw.score})
                                </span>
                            `).join('')}
                        </div>
                        <div class="platform-distribution">
                            <strong>í”Œë«í¼ ë¶„í¬:</strong> 
                            ${Object.entries(ageGroup.platform_distribution).map(([platform, count]) => 
                                `${platform}: ${count}`
                            ).join(', ')}
                        </div>
                    `;
                    container.appendChild(ageDiv);
                });
                
            } catch (error) {
                console.error('ì—°ë ¹ëŒ€ë³„ í‚¤ì›Œë“œ ë¶„ì„ ì‹¤íŒ¨:', error);
                document.getElementById('age-group-results').innerHTML = 
                    '<p class="error">ì—°ë ¹ëŒ€ë³„ í‚¤ì›Œë“œ ë¶„ì„ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
            }
        }
        
        // ì—°ë ¹ëŒ€ë³„ íŠ¸ë Œë“œ ë¶„ì„ ë¡œë“œ
        async function loadAgeGroupTrends() {
            try {
                const ageGroups = ['10ëŒ€', '20ëŒ€', '30ëŒ€', '40ëŒ€', '50ëŒ€+'];
                const container = document.getElementById('age-trends-results');
                container.innerHTML = '<h3>ì—°ë ¹ëŒ€ë³„ íŠ¸ë Œë“œ ë¶„ì„</h3>';
                
                for (const ageGroup of ageGroups) {
                    const response = await fetch(`/api/age-analysis/trends/${encodeURIComponent(ageGroup)}?max_results=10`);
                    const data = await response.json();
                    
                    const ageDiv = document.createElement('div');
                    ageDiv.className = 'age-trends';
                    ageDiv.innerHTML = `
                        <h4>${data.age_group} íŠ¸ë Œë“œ</h4>
                        <div class="top-keywords">
                            <strong>ìƒìœ„ í‚¤ì›Œë“œ:</strong>
                            ${data.top_keywords.map((kw, index) => `
                                <span class="keyword-tag">${index + 1}. ${kw.keyword}</span>
                            `).join('')}
                        </div>
                        <div class="platform-preferences">
                            <strong>í”Œë«í¼ ì„ í˜¸ë„:</strong>
                            ${Object.entries(data.platform_preferences).map(([platform, percentage]) => 
                                `${platform}: ${percentage}%`
                            ).join(', ')}
                        </div>
                    `;
                    container.appendChild(ageDiv);
                }
                
            } catch (error) {
                console.error('ì—°ë ¹ëŒ€ë³„ íŠ¸ë Œë“œ ë¶„ì„ ì‹¤íŒ¨:', error);
                document.getElementById('age-trends-results').innerHTML = 
                    '<p class="error">ì—°ë ¹ëŒ€ë³„ íŠ¸ë Œë“œ ë¶„ì„ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
            }
        }
        
        // íŠ¹ì • í‚¤ì›Œë“œ ì—°ë ¹ëŒ€ ë¶„ì„
        async function analyzeSpecificKeyword() {
            const keyword = document.getElementById('keywordForAnalysis').value.trim();
            if (!keyword) {
                alert('ë¶„ì„í•  í‚¤ì›Œë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            try {
                const response = await fetch(`/api/age-analysis/keyword/${encodeURIComponent(keyword)}`);
                const data = await response.json();
                
                const container = document.getElementById('keyword-analysis-results');
                container.innerHTML = `
                    <h3>"${data.keyword}" ì—°ë ¹ëŒ€ë³„ ë¶„ì„</h3>
                    <div class="keyword-summary">
                        <p><strong>ì „ì²´ ì–¸ê¸‰ ìˆ˜:</strong> ${data.total_mentions}</p>
                        <p><strong>íŠ¸ë Œë“œ ë°©í–¥:</strong> ${data.trending_trend}</p>
                        <p><strong>ê°ì • ì ìˆ˜:</strong> ${data.sentiment_score || 'N/A'}</p>
                    </div>
                    
                    <div class="age-groups-analysis">
                        <h4>ì—°ë ¹ëŒ€ë³„ ë¶„ì„</h4>
                        ${Object.entries(data.age_groups).map(([ageGroup, analysis]) => `
                            <div class="age-analysis-item">
                                <h5>${ageGroup}</h5>
                                <p>ì–¸ê¸‰ ìˆ˜: ${analysis.mentions}</p>
                                <p>ê´€ë ¨ì„± ì ìˆ˜: ${analysis.relevance_score}</p>
                                <p>íŠ¸ë Œë”© ë ˆë²¨: ${analysis.trending_level}</p>
                                <p>í”Œë«í¼ ë¶„í¬: ${Object.entries(analysis.platform_mentions).map(([platform, count]) => 
                                    `${platform}: ${count}`
                                ).join(', ')}</p>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="related-keywords">
                        <h4>ê´€ë ¨ í‚¤ì›Œë“œ</h4>
                        ${data.related_keywords.map(kw => `<span class="keyword-tag">${kw}</span>`).join('')}
                    </div>
                `;
                
            } catch (error) {
                console.error('í‚¤ì›Œë“œ ë¶„ì„ ì‹¤íŒ¨:', error);
                document.getElementById('keyword-analysis-results').innerHTML = 
                    '<p class="error">í‚¤ì›Œë“œ ë¶„ì„ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
            }
        }
    </script>
</body>
</html> 