<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>íŠ¸ë Œë“œ í‚¤ì›Œë“œ ëŒ€ì‹œë³´ë“œ</title>
    <link rel="stylesheet" href="/static/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <h1>íŠ¸ë Œë“œ í‚¤ì›Œë“œ ëŒ€ì‹œë³´ë“œ</h1>
    
    <!-- ì‹¤ì‹œê°„ ì¸ê¸° ê²€ìƒ‰ì–´ ì„¹ì…˜ -->
    <div class="trending-section">
        <h2>ğŸ”¥ ì‹¤ì‹œê°„ ì¸ê¸° ê²€ìƒ‰ì–´</h2>
        <div id="trending-keywords" class="trending-keywords">
            <p>ë¡œë”© ì¤‘...</p>
        </div>
        <button onclick="loadTrendingKeywords()" class="refresh-btn">ìƒˆë¡œê³ ì¹¨</button>
    </div>
    
    <!-- í‚¤ì›Œë“œ ì…ë ¥ í¼ -->
    <div class="search-section">
        <h2>ğŸ” í‚¤ì›Œë“œ ê²€ìƒ‰</h2>
        <form method="get" action="/web">
            <input type="text" name="keyword" value="{{ keyword }}" placeholder="í‚¤ì›Œë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”" required>
            <button type="submit">ê²€ìƒ‰</button>
        </form>
    </div>

    <!-- YouTube íŠ¸ë Œë“œ ë¶„ì„ ì„¹ì…˜ -->
    <div class="youtube-analyze-section">
        <h2>ğŸ¬ YouTube íŠ¸ë Œë“œ ë¶„ì„</h2>
        <div class="analyze-panels">
            <div class="panel">
                <h3>ì±„ë„ í•¸ë“¤ëª…</h3>
                <textarea id="channelHandles" placeholder="@handle í˜•ì‹, ì¤„ë°”ê¿ˆìœ¼ë¡œ ì—¬ëŸ¬ ê°œ ì…ë ¥"></textarea>
            </div>
            <div class="panel">
                <h3>í‚¤ì›Œë“œ ì…ë ¥</h3>
                <textarea id="analyzeKeywords" placeholder="í‚¤ì›Œë“œ, ì¤„ë°”ê¿ˆìœ¼ë¡œ ì—¬ëŸ¬ ê°œ ì…ë ¥"></textarea>
            </div>
            <div class="panel settings">
                <h3>ì„¤ì •</h3>
                <div class="grid-2">
                    <label>ì‹¤í–‰ëª¨ë“œ
                        <select id="mode">
                            <option value="channel">ì±„ë„</option>
                            <option value="keyword" selected>í‚¤ì›Œë“œ</option>
                            <option value="both">ë‘˜ë‹¤</option>
                        </select>
                    </label>
                    <label>ì‡¼ì¸ /ë¡±í¼
                        <select id="form">
                            <option value="both" selected>ë‘˜ë‹¤</option>
                            <option value="shorts">ì‡¼ì¸ </option>
                            <option value="long">ë¡±í¼</option>
                        </select>
                    </label>
                    <label>ì‡¼ì¸  ê¸°ì¤€(ì´ˆ)
                        <input id="shortsThreshold" type="number" value="180" min="10">
                    </label>
                    <label>ìµœê·¼ ë©°ì¹ ê°„ ë¶„ì„
                        <input id="timeframeDays" type="number" value="30" min="1">
                    </label>
                    <label>ëŒ€ìƒêµ­ê°€
                        <input id="region" type="text" value="KR">
                    </label>
                    <label>ì–¸ì–´
                        <input id="language" type="text" value="ko">
                    </label>
                    <label>ì±„ë„ë‹¹ ìµœëŒ€ ê²€ìƒ‰ ìˆ˜
                        <input id="maxPerChannel" type="number" value="10" min="1" max="50">
                    </label>
                    <label>ê²€ìƒ‰ì–´ë‹¹ ìµœëŒ€ ê²€ìƒ‰ ìˆ˜
                        <input id="maxPerKeyword" type="number" value="50" min="1" max="50">
                    </label>
                    <label>ìµœì†Œ ì¡°íšŒìˆ˜
                        <input id="minViewCount" type="number" value="20000" min="0">
                    </label>
                    <label>ìµœì†Œ ì‹œê°„ë‹¹ ì¡°íšŒìˆ˜
                        <input id="minVph" type="number" value="600" step="0.1" min="0">
                    </label>
                    <label>ì¿¼í„° ì†Œì§„ì‹œ ëŒ€ê¸°(ë¶„)
                        <input id="waitMinutes" type="number" value="30" min="0">
                    </label>
                    <label>API í‚¤ ëŒ€ê¸° ìƒíƒœ
                        <select id="quotaBehavior">
                            <option value="none" selected>ëŒ€ê¸° ì¤‘ì´ ì•„ë‹˜</option>
                            <option value="skip">ëŒ€ê¸° ìŠ¤í‚µ í›„ ë‹¤ìŒ í‚¤ë¡œ</option>
                            <option value="wait">ëŒ€ê¸°</option>
                        </select>
                    </label>
                </div>
            </div>
        </div>
        <div class="api-key-row">
            <div>
                <strong>API Key</strong> Â· YouTube Data API v3 í‚¤:
                <input id="ytApiKeyUi" type="password" placeholder="ì¤€ë¹„ì¤‘ì…ë‹ˆë‹¤." disabled>
                <small class="muted">(ì„œë²„ì˜ .env í‚¤ ì‚¬ìš© Â· ì¤€ë¹„ì¤‘ì…ë‹ˆë‹¤.)</small>
            </div>
            <div class="actions">
                <button id="btnStartAnalyze" class="primary" onclick="startAnalyze()">ì‹œì‘í•˜ê¸°</button>
                <button onclick="stopAnalyze()">ì¤‘ë‹¨í•˜ê¸°</button>
                <button onclick="clearAnalyzeResults()">ê²°ê³¼ ì§€ìš°ê¸°</button>
                <button onclick="exportAnalyzeExcel()">ì—‘ì…€ë¡œ ì €ì¥</button>
                <button onclick="saveCurrentJob()">í˜„ì¬ ì‘ì—… ì €ì¥</button>
                <button onclick="loadSavedJob()">ì‘ì—… ë¶ˆëŸ¬ì˜¤ê¸°</button>
                <button onclick="alert('ì¤€ë¹„ì¤‘ì…ë‹ˆë‹¤.')">ë¼ì´ì„ ìŠ¤ ê´€ë¦¬</button>
            </div>
        </div>

        <div id="analyzeLog" class="analyze-log"></div>

        <div class="results-section" id="analyzeResults" style="display:none;">
            <h3>ê²°ê³¼</h3>
            <div class="pager-row">
                <label>í˜ì´ì§€ í¬ê¸°
                    <select id="pageSize" onchange="setPageSize(this.value)">
                        <option value="10">10</option>
                        <option value="25" selected>25</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                </label>
                <div class="pager-actions">
                    <button onclick="prevPage()">ì´ì „</button>
                    <span id="pageInfo"></span>
                    <button onclick="nextPage()">ë‹¤ìŒ</button>
                </div>
            </div>
            <div class="table-scroll">
                <table id="analyzeTable">
                    <thead>
                        <tr>
                            <th>ì±„ë„ëª…</th>
                            <th>ì œëª©</th>
                            <th>ì—…ë¡œë“œë¨</th>
                            <th>ì¡°íšŒìˆ˜</th>
                            <th>ì‹œê°„ë‹¹ ì¡°íšŒìˆ˜</th>
                            <th>êµ¬ë…ììˆ˜</th>
                            <th>ì¡°íšŒìˆ˜/êµ¬ë…ììˆ˜</th>
                            <th>ì˜ìƒ ê¸¸ì´</th>
                            <th>ì˜ìƒ ë§í¬</th>
                            <th>ì—´ê¸°</th>
                            <th>ì¸ë„¤ì¼</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="viewer-row">
                <div class="viewer">
                    <h4>ë¯¸ë””ì–´ ë·°ì–´</h4>
                    <div id="mediaViewer" class="media-viewer">
                        <p class="muted">ì˜ìƒì„ ì„ íƒí•˜ë©´ ì´ ì˜ì—­ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Google Trends ì‹¤ì‹œê°„ ì¸ê¸° ê²€ìƒ‰ì–´ ì„¹ì…˜ -->
    <div class="google-trends-section">
        <h2>ğŸ“Š Google Trends ì‹¤ì‹œê°„ ì¸ê¸° ê²€ìƒ‰ì–´</h2>
        <div class="google-trends-controls">
            <select id="regionSelect" onchange="loadGoogleTrends()">
                <option value="KR">í•œêµ­</option>
                <option value="US">ë¯¸êµ­</option>
                <option value="JP">ì¼ë³¸</option>
                <option value="CN">ì¤‘êµ­</option>
                <option value="GB">ì˜êµ­</option>
            </select>
            <button onclick="loadGoogleTrends()" class="trends-btn">ì‹¤ì‹œê°„ ì¸ê¸° ê²€ìƒ‰ì–´</button>
            <button onclick="loadGoogleTrendsByCategory()" class="trends-btn">ì¹´í…Œê³ ë¦¬ë³„ ì¸ê¸° ê²€ìƒ‰ì–´</button>
            <div class="keyword-input-group">
                <input type="text" id="googleTrendsKeyword" placeholder="í‚¤ì›Œë“œ ì…ë ¥">
                <button onclick="analyzeGoogleTrendsKeyword()" class="trends-btn">í‚¤ì›Œë“œ ë¶„ì„</button>
            </div>
        </div>
        
        <!-- Google Trends ê²°ê³¼ -->
        <div id="google-trends-results" class="google-trends-results">
            <p>ì§€ì—­ì„ ì„ íƒí•˜ê³  ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ Google Trends ë°ì´í„°ë¥¼ í™•ì¸í•˜ì„¸ìš”.</p>
        </div>
    </div>
    
    <!-- ì—°ë ¹ëŒ€ë³„ í‚¤ì›Œë“œ ë¶„ì„ ì„¹ì…˜ -->
    <div class="age-analysis-section">
        <h2>ğŸ‘¥ ì—°ë ¹ëŒ€ë³„ í‚¤ì›Œë“œ ë¶„ì„</h2>
        <div class="age-analysis-controls">
            <button onclick="loadAgeGroupKeywords()" class="analysis-btn">ì—°ë ¹ëŒ€ë³„ í‚¤ì›Œë“œ ë¶„ì„</button>
            <button onclick="loadAgeGroupTrends()" class="analysis-btn">ì—°ë ¹ëŒ€ë³„ íŠ¸ë Œë“œ ë¶„ì„</button>
            <div class="keyword-input-group">
                <input type="text" id="keywordForAnalysis" placeholder="ë¶„ì„í•  í‚¤ì›Œë“œ ì…ë ¥">
                <button onclick="analyzeSpecificKeyword()" class="analysis-btn">í‚¤ì›Œë“œ ì—°ë ¹ëŒ€ ë¶„ì„</button>
            </div>
        </div>
        
        <!-- ì—°ë ¹ëŒ€ë³„ í‚¤ì›Œë“œ ê²°ê³¼ -->
        <div id="age-group-results" class="age-group-results">
            <p>ë¶„ì„ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ì—°ë ¹ëŒ€ë³„ í‚¤ì›Œë“œë¥¼ í™•ì¸í•˜ì„¸ìš”.</p>
        </div>
        
        <!-- ì—°ë ¹ëŒ€ë³„ íŠ¸ë Œë“œ ê²°ê³¼ -->
        <div id="age-trends-results" class="age-trends-results">
            <p>ë¶„ì„ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ì—°ë ¹ëŒ€ë³„ íŠ¸ë Œë“œë¥¼ í™•ì¸í•˜ì„¸ìš”.</p>
        </div>
        
        <!-- íŠ¹ì • í‚¤ì›Œë“œ ë¶„ì„ ê²°ê³¼ -->
        <div id="keyword-analysis-results" class="keyword-analysis-results">
            <p>í‚¤ì›Œë“œë¥¼ ì…ë ¥í•˜ê³  ë¶„ì„ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.</p>
        </div>
    </div>
    
    {% if error %}
        <div class="error">ì—ëŸ¬: {{ error }}</div>
    {% endif %}
    
    {% if keyword %}
    <div class="results-section">
        <div class="placeholder-block">
            <img src="/static/coming-soon.png" alt="ì¤€ë¹„ì¤‘ì…ë‹ˆë‹¤." class="placeholder-image" onerror="this.style.display='none';document.getElementById('placeholder-text').style.display='block';">
            <p id="placeholder-text" class="placeholder-text">ì¤€ë¹„ì¤‘ì…ë‹ˆë‹¤.</p>
        </div>
    </div>
    {% endif %}
    
    <script>
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤ì‹œê°„ ì¸ê¸° ê²€ìƒ‰ì–´ ë¡œë“œ
        window.onload = function() {
            loadTrendingKeywords();
        };
        
        // ì‹¤ì‹œê°„ ì¸ê¸° ê²€ìƒ‰ì–´ ë¡œë“œ í•¨ìˆ˜
        async function loadTrendingKeywords() {
            try {
                const response = await fetch('/api/trends/keywords?max_results=20');
                const data = await response.json();
                
                const container = document.getElementById('trending-keywords');
                container.innerHTML = '';
                
                data.trending_keywords.forEach((item, index) => {
                    const keywordDiv = document.createElement('div');
                    keywordDiv.className = 'keyword-item';
                    keywordDiv.innerHTML = `
                        <span class="rank">${index + 1}</span>
                        <span class="keyword">${item.keyword}</span>
                        <span class="score">ğŸ”¥ ${item.trending_score}</span>
                        <span class="platforms">${item.platforms.join(', ')}</span>
                        <span class="views">ğŸ‘ï¸ ${(item.total_views / 1000).toFixed(0)}K</span>
                    `;
                    container.appendChild(keywordDiv);
                });
                
                // ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸ ì‹œê°„ í‘œì‹œ
                const updateTime = document.createElement('div');
                updateTime.className = 'update-time';
                updateTime.innerHTML = `ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ${new Date().toLocaleTimeString()}`;
                container.appendChild(updateTime);
                
            } catch (error) {
                console.error('ì¸ê¸° ê²€ìƒ‰ì–´ ë¡œë“œ ì‹¤íŒ¨:', error);
                document.getElementById('trending-keywords').innerHTML = 
                    '<p class="error">ì¸ê¸° ê²€ìƒ‰ì–´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
            }
        }
        
        // 5ë¶„ë§ˆë‹¤ ìë™ ìƒˆë¡œê³ ì¹¨
        setInterval(loadTrendingKeywords, 5 * 60 * 1000);

        // ------------------ YouTube ë¶„ì„ ------------------
        let analyzeAbortController = null;
        let analyzeRows = [];
        let currentPage = 1;
        let pageSize = 25;

        function collectAnalyzePayload() {
            // í•œê¸€: í¼ ê°’ì„ ìˆ˜ì§‘í•˜ì—¬ API ìš”ì²­ í˜ì´ë¡œë“œ êµ¬ì„±
            const parseList = (v) => v.split(/\n+/).map(s => s.trim()).filter(Boolean);
            return {
                mode: document.getElementById('mode').value,
                channel_handles: parseList(document.getElementById('channelHandles').value),
                keywords: parseList(document.getElementById('analyzeKeywords').value),
                form: document.getElementById('form').value,
                shorts_threshold_seconds: Number(document.getElementById('shortsThreshold').value || 180),
                timeframe_days: Number(document.getElementById('timeframeDays').value || 30),
                region: document.getElementById('region').value || 'KR',
                language: document.getElementById('language').value || 'ko',
                max_per_channel: Number(document.getElementById('maxPerChannel').value || 10),
                max_per_keyword: Number(document.getElementById('maxPerKeyword').value || 50),
                min_view_count: Number(document.getElementById('minViewCount').value || 20000),
                min_views_per_hour: Number(document.getElementById('minVph').value || 600),
                wait_minutes_on_quota: Number(document.getElementById('waitMinutes').value || 30),
                quota_wait_behavior: document.getElementById('quotaBehavior').value
            };
        }

        async function startAnalyze() {
            try {
                const payload = collectAnalyzePayload();
                const log = document.getElementById('analyzeLog');
                log.innerText = `[${new Date().toLocaleTimeString()}] ì‹œì‘ | ì„¤ì • ë¡œë“œ...`;

                analyzeAbortController = new AbortController();
                const resp = await fetch('/api/youtube/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                    signal: analyzeAbortController.signal
                });

                if (!resp.ok) {
                    const errText = await resp.text();
                    log.innerText += `\n[ì˜¤ë¥˜] ${errText}`;
                    alert('ë¶„ì„ ìš”ì²­ ì‹¤íŒ¨: ' + resp.status);
                    return;
                }

                const data = await resp.json();
                renderAnalyzeResults(data);
                log.innerText += `\n[ì™„ë£Œ] ì´ ${data.total}ê±´ ì¤‘ ${data.filtered}ê±´ í‘œì‹œ`;
            } catch (e) {
                if (e.name === 'AbortError') {
                    document.getElementById('analyzeLog').innerText += `\n[ì¤‘ë‹¨] ì‚¬ìš©ìê°€ ì¤‘ë‹¨í–ˆìŠµë‹ˆë‹¤.`;
                } else {
                    document.getElementById('analyzeLog').innerText += `\n[ì˜¤ë¥˜] ${e}`;
                }
            }
        }

        function stopAnalyze() {
            if (analyzeAbortController) {
                analyzeAbortController.abort();
            }
        }

        function clearAnalyzeResults() {
            document.querySelector('#analyzeTable tbody').innerHTML = '';
            document.getElementById('analyzeResults').style.display = 'none';
            document.getElementById('analyzeLog').innerText = '';
            document.getElementById('mediaViewer').innerHTML = '<p class="muted">ì˜ìƒì„ ì„ íƒí•˜ë©´ ì´ ì˜ì—­ì— í‘œì‹œë©ë‹ˆë‹¤.</p>';
            analyzeRows = [];
            currentPage = 1;
        }

        function renderAnalyzeResults(data) {
            analyzeRows = data.rows || [];
            currentPage = 1;
            renderAnalyzePage();
            document.getElementById('analyzeResults').style.display = '';
        }

        function renderAnalyzePage() {
            const tbody = document.querySelector('#analyzeTable tbody');
            tbody.innerHTML = '';
            const total = analyzeRows.length;
            const start = (currentPage - 1) * pageSize;
            const end = Math.min(start + pageSize, total);
            for (let i = start; i < end; i++) {
                const row = analyzeRows[i];
                const ratio = row.view_to_subscriber_ratio == null ? '' : Number(row.view_to_subscriber_ratio).toFixed(2);
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row.channel_name || ''}</td>
                    <td>${escapeHtml(row.title || '')}</td>
                    <td>${row.published_at ? new Date(row.published_at).toLocaleString() : ''}</td>
                    <td>${fmtNum(row.view_count)}</td>
                    <td>${fmtNum(row.views_per_hour)}</td>
                    <td>${fmtNum(row.subscriber_count)}</td>
                    <td>${ratio}</td>
                    <td>${row.duration || ''}</td>
                    <td><a href="${row.video_url}" onclick="showVideo('${encodeURIComponentForAttr('${' + 'row.video_url' + '}')}'); return false;">ë§í¬</a></td>
                    <td><button onclick="showVideo('${escapeJs(row.video_url)}')">ì˜ìƒ ì—´ê¸°</button></td>
                    <td>${row.thumbnail_url ? `<button onclick=\"showThumb('${escapeJs(row.thumbnail_url)}')\">ì¸ë„¤ì¼ ì—´ê¸°</button>` : ''}</td>
                `;
                tbody.appendChild(tr);
            }
            const pageInfo = document.getElementById('pageInfo');
            const totalPages = Math.max(1, Math.ceil(total / pageSize));
            pageInfo.textContent = `${currentPage} / ${totalPages} (ì´ ${fmtNum(total)}ê±´)`;
        }

        function setPageSize(v) { pageSize = Number(v||25); currentPage = 1; renderAnalyzePage(); }
        function prevPage() { if (currentPage > 1) { currentPage--; renderAnalyzePage(); } }
        function nextPage() { const totalPages = Math.max(1, Math.ceil((analyzeRows.length||0)/pageSize)); if (currentPage < totalPages) { currentPage++; renderAnalyzePage(); } }

        function showVideo(url) {
            if (!url) return;
            const viewer = document.getElementById('mediaViewer');
            const safe = escapeHtml(url);
            viewer.innerHTML = `<video controls src="${safe}" style="max-width:100%;height:auto"></video>`;
            // YouTube ë§í¬ì¸ ê²½ìš° iframeìœ¼ë¡œ ì²˜ë¦¬
            if (/youtube\.com|youtu\.be/.test(url)) {
                const vid = extractYouTubeId(url);
                if (vid) viewer.innerHTML = `<iframe width="560" height="315" src="https://www.youtube.com/embed/${vid}" frameborder="0" allowfullscreen></iframe>`;
            }
        }

        function showThumb(url) {
            if (!url) return;
            const viewer = document.getElementById('mediaViewer');
            const safe = escapeHtml(url);
            viewer.innerHTML = `<img src="${safe}" alt="thumbnail" style="max-width:100%;height:auto" />`;
        }

        function extractYouTubeId(u){
            try {
                const m = String(u).match(/[?&]v=([^&#]+)/) || String(u).match(/youtu\.be\/([^?&#]+)/);
                return m ? m[1] : '';
            } catch { return ''; }
        }

        function exportAnalyzeExcel() {
            const payload = collectAnalyzePayload();
            const a = document.createElement('a');
            a.href = '/api/youtube/analyze/export';
            // POSTë¡œ ë³´ë‚´ì•¼ í•˜ë¯€ë¡œ fetch í›„ blob ë‹¤ìš´ë¡œë“œ
            fetch('/api/youtube/analyze/export', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            }).then(r => {
                if (!r.ok) throw new Error('ì—‘ì…€ ìš”ì²­ ì‹¤íŒ¨');
                return r.blob();
            }).then(blob => {
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'youtube_analysis.xlsx';
                document.body.appendChild(link);
                link.click();
                link.remove();
                URL.revokeObjectURL(url);
            }).catch(err => alert(err));
        }

        function saveCurrentJob() {
            try {
                const key = 'yt_analyze_job_v1';
                localStorage.setItem(key, JSON.stringify(collectAnalyzePayload()));
                alert('í˜„ì¬ ì‘ì—… ì €ì¥ ì™„ë£Œ');
            } catch (e) { alert('ì €ì¥ ì‹¤íŒ¨'); }
        }

        function loadSavedJob() {
            try {
                const key = 'yt_analyze_job_v1';
                const data = JSON.parse(localStorage.getItem(key) || '{}');
                if (!Object.keys(data).length) { alert('ì €ì¥ëœ ì‘ì—…ì´ ì—†ìŠµë‹ˆë‹¤.'); return; }
                // í•œê¸€: ê° í•„ë“œ ì±„ìš°ê¸°
                document.getElementById('mode').value = data.mode || 'keyword';
                document.getElementById('form').value = data.form || 'both';
                document.getElementById('shortsThreshold').value = data.shorts_threshold_seconds ?? 180;
                document.getElementById('timeframeDays').value = data.timeframe_days ?? 30;
                document.getElementById('region').value = data.region || 'KR';
                document.getElementById('language').value = data.language || 'ko';
                document.getElementById('maxPerChannel').value = data.max_per_channel ?? 10;
                document.getElementById('maxPerKeyword').value = data.max_per_keyword ?? 50;
                document.getElementById('minViewCount').value = data.min_view_count ?? 20000;
                document.getElementById('minVph').value = data.min_views_per_hour ?? 600;
                document.getElementById('waitMinutes').value = data.wait_minutes_on_quota ?? 30;
                document.getElementById('quotaBehavior').value = data.quota_wait_behavior || 'none';
                document.getElementById('channelHandles').value = (data.channel_handles || []).join('\n');
                document.getElementById('analyzeKeywords').value = (data.keywords || []).join('\n');
                alert('ì‘ì—… ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ');
            } catch (e) { alert('ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨'); }
        }

        function fmtNum(v){ return (v===null||v===undefined||Number.isNaN(v))?'': new Intl.NumberFormat().format(v); }
        function escapeHtml(str){ return (str||'').replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[s])); }
        function escapeJs(str){ return String(str||'').replace(/['"\\]/g, m => ({"'":"\\'","\"":"\\\"","\\":"\\\\"}[m])); }
        
        // Google Trends ì‹¤ì‹œê°„ ì¸ê¸° ê²€ìƒ‰ì–´ ë¡œë“œ
        async function loadGoogleTrends() {
            const region = document.getElementById('regionSelect').value;
            try {
                const response = await fetch(`/api/google-trends/realtime?region=${region}`);
                const data = await response.json();
                
                const container = document.getElementById('google-trends-results');
                container.innerHTML = `
                    <h3>ğŸŒ ${getRegionName(region)} ì‹¤ì‹œê°„ ì¸ê¸° ê²€ìƒ‰ì–´</h3>
                    <div class="trending-list">
                        ${data.trending_searches.map((item, index) => `
                            <div class="trending-item">
                                <span class="rank">${item.rank}</span>
                                <span class="keyword">${item.keyword}</span>
                                <span class="source">${item.source}</span>
                            </div>
                        `).join('')}
                    </div>
                    <p class="update-time">ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ${new Date().toLocaleTimeString()}</p>
                `;
                
            } catch (error) {
                console.error('Google Trends ë¡œë“œ ì‹¤íŒ¨:', error);
                document.getElementById('google-trends-results').innerHTML = 
                    '<p class="error">Google Trends ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
            }
        }
        
        // Google Trends ì¹´í…Œê³ ë¦¬ë³„ ì¸ê¸° ê²€ìƒ‰ì–´ ë¡œë“œ
        async function loadGoogleTrendsByCategory() {
            const region = document.getElementById('regionSelect').value;
            const categories = ['entertainment', 'business', 'sports', 'health', 'science_tech'];
            
            try {
                const container = document.getElementById('google-trends-results');
                container.innerHTML = '<h3>ğŸ“‚ ì¹´í…Œê³ ë¦¬ë³„ ì¸ê¸° ê²€ìƒ‰ì–´</h3>';
                
                for (const category of categories) {
                    const response = await fetch(`/api/google-trends/category/${category}?region=${region}`);
                    const data = await response.json();
                    
                    const categoryDiv = document.createElement('div');
                    categoryDiv.className = 'category-trends';
                    categoryDiv.innerHTML = `
                        <h4>${getCategoryName(category)}</h4>
                        <div class="trending-list">
                            ${data.trending_searches.slice(0, 5).map((item, index) => `
                                <div class="trending-item">
                                    <span class="rank">${item.rank}</span>
                                    <span class="keyword">${item.keyword}</span>
                                </div>
                            `).join('')}
                        </div>
                    `;
                    container.appendChild(categoryDiv);
                }
                
            } catch (error) {
                console.error('ì¹´í…Œê³ ë¦¬ë³„ Google Trends ë¡œë“œ ì‹¤íŒ¨:', error);
                document.getElementById('google-trends-results').innerHTML = 
                    '<p class="error">ì¹´í…Œê³ ë¦¬ë³„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
            }
        }
        
        // Google Trends í‚¤ì›Œë“œ ë¶„ì„
        async function analyzeGoogleTrendsKeyword() {
            const keyword = document.getElementById('googleTrendsKeyword').value.trim();
            const region = document.getElementById('regionSelect').value;
            
            if (!keyword) {
                alert('ë¶„ì„í•  í‚¤ì›Œë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            try {
                const container = document.getElementById('google-trends-results');
                container.innerHTML = '<h3>ğŸ” í‚¤ì›Œë“œ ë¶„ì„ ì¤‘...</h3>';
                
                // ì—¬ëŸ¬ API í˜¸ì¶œ
                const [interestData, relatedData, regionData, ageData] = await Promise.all([
                    fetch(`/api/google-trends/keyword/${encodeURIComponent(keyword)}/interest?region=${region}`).then(r => r.json()),
                    fetch(`/api/google-trends/keyword/${encodeURIComponent(keyword)}/related?region=${region}`).then(r => r.json()),
                    fetch(`/api/google-trends/keyword/${encodeURIComponent(keyword)}/regions?region=${region}`).then(r => r.json()),
                    fetch(`/api/google-trends/keyword/${encodeURIComponent(keyword)}/age-groups?region=${region}`).then(r => r.json())
                ]);
                
                container.innerHTML = `
                    <h3>"${keyword}" Google Trends ë¶„ì„</h3>
                    
                    <div class="analysis-section">
                        <h4>ğŸ“ˆ ê´€ì‹¬ë„ ì¶”ì´</h4>
                        <p>í‰ê·  ê´€ì‹¬ë„: ${interestData.average_interest}/100</p>
                        <p>ìµœëŒ€ ê´€ì‹¬ë„: ${interestData.max_interest}/100</p>
                        <p>ë°ì´í„° ì†ŒìŠ¤: ${interestData.source}</p>
                    </div>
                    
                    <div class="analysis-section">
                        <h4>ğŸ”— ê´€ë ¨ ê²€ìƒ‰ì–´</h4>
                        <div class="related-queries">
                            <h5>ìƒìœ„ ê´€ë ¨ ê²€ìƒ‰ì–´:</h5>
                            ${relatedData.top_queries.map(q => `<span class="query-tag">${q.query} (${q.value})</span>`).join('')}
                        </div>
                        <div class="related-queries">
                            <h5>ê¸‰ìƒìŠ¹ ê´€ë ¨ ê²€ìƒ‰ì–´:</h5>
                            ${relatedData.rising_queries.map(q => `<span class="query-tag rising">${q.query} (${q.value})</span>`).join('')}
                        </div>
                    </div>
                    
                    <div class="analysis-section">
                        <h4>ğŸŒ ì§€ì—­ë³„ ê´€ì‹¬ë„</h4>
                        <div class="region-interest">
                            ${regionData.regions.slice(0, 5).map(r => `
                                <div class="region-item">
                                    <span class="region-name">${r.region}</span>
                                    <span class="interest-score">${r.interest}/100</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div class="analysis-section">
                        <h4>ğŸ‘¥ ì—°ë ¹ëŒ€ë³„ ê´€ì‹¬ë„ (ì¶”ì •)</h4>
                        <div class="age-interest">
                            ${ageData.age_groups.map(age => `
                                <div class="age-item">
                                    <span class="age-group">${age.age_group}</span>
                                    <span class="interest-score">${age.interest}/100</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                
            } catch (error) {
                console.error('Google Trends í‚¤ì›Œë“œ ë¶„ì„ ì‹¤íŒ¨:', error);
                document.getElementById('google-trends-results').innerHTML = 
                    '<p class="error">í‚¤ì›Œë“œ ë¶„ì„ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
            }
        }
        
        // ì§€ì—­ëª… ë³€í™˜
        function getRegionName(region) {
            const regionNames = {
                'KR': 'í•œêµ­', 'US': 'ë¯¸êµ­', 'JP': 'ì¼ë³¸', 'CN': 'ì¤‘êµ­', 'GB': 'ì˜êµ­'
            };
            return regionNames[region] || region;
        }
        
        // ì¹´í…Œê³ ë¦¬ëª… ë³€í™˜
        function getCategoryName(category) {
            const categoryNames = {
                'entertainment': 'ì—”í„°í…Œì¸ë¨¼íŠ¸',
                'business': 'ë¹„ì¦ˆë‹ˆìŠ¤',
                'sports': 'ìŠ¤í¬ì¸ ',
                'health': 'ê±´ê°•',
                'science_tech': 'ê³¼í•™ê¸°ìˆ '
            };
            return categoryNames[category] || category;
        }
        
        // ì—°ë ¹ëŒ€ë³„ í‚¤ì›Œë“œ ë¶„ì„ ë¡œë“œ
        async function loadAgeGroupKeywords() {
            try {
                const response = await fetch('/api/age-analysis/keywords?max_results=15');
                const data = await response.json();
                
                const container = document.getElementById('age-group-results');
                container.innerHTML = '<h3>ì—°ë ¹ëŒ€ë³„ ì¸ê¸° í‚¤ì›Œë“œ</h3>';
                
                data.forEach(ageGroup => {
                    const ageDiv = document.createElement('div');
                    ageDiv.className = 'age-group';
                    ageDiv.innerHTML = `
                        <h4>${ageGroup.age_group} (íŠ¸ë Œë”© ì ìˆ˜: ${ageGroup.trending_score})</h4>
                        <div class="keywords-list">
                            ${ageGroup.keywords.map((kw, index) => `
                                <span class="keyword-tag ${kw.trending_level.replace(/\s+/g, '-').toLowerCase()}">
                                    ${index + 1}. ${kw.keyword} (${kw.score})
                                </span>
                            `).join('')}
                        </div>
                        <div class="platform-distribution">
                            <strong>í”Œë«í¼ ë¶„í¬:</strong> 
                            ${Object.entries(ageGroup.platform_distribution).map(([platform, count]) => 
                                `${platform}: ${count}`
                            ).join(', ')}
                        </div>
                    `;
                    container.appendChild(ageDiv);
                });
                
            } catch (error) {
                console.error('ì—°ë ¹ëŒ€ë³„ í‚¤ì›Œë“œ ë¶„ì„ ì‹¤íŒ¨:', error);
                document.getElementById('age-group-results').innerHTML = 
                    '<p class="error">ì—°ë ¹ëŒ€ë³„ í‚¤ì›Œë“œ ë¶„ì„ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
            }
        }
        
        // ì—°ë ¹ëŒ€ë³„ íŠ¸ë Œë“œ ë¶„ì„ ë¡œë“œ
        async function loadAgeGroupTrends() {
            try {
                const ageGroups = ['10ëŒ€', '20ëŒ€', '30ëŒ€', '40ëŒ€', '50ëŒ€+'];
                const container = document.getElementById('age-trends-results');
                container.innerHTML = '<h3>ì—°ë ¹ëŒ€ë³„ íŠ¸ë Œë“œ ë¶„ì„</h3>';
                
                for (const ageGroup of ageGroups) {
                    const response = await fetch(`/api/age-analysis/trends/${encodeURIComponent(ageGroup)}?max_results=10`);
                    const data = await response.json();
                    
                    const ageDiv = document.createElement('div');
                    ageDiv.className = 'age-trends';
                    ageDiv.innerHTML = `
                        <h4>${data.age_group} íŠ¸ë Œë“œ</h4>
                        <div class="top-keywords">
                            <strong>ìƒìœ„ í‚¤ì›Œë“œ:</strong>
                            ${data.top_keywords.map((kw, index) => `
                                <span class="keyword-tag">${index + 1}. ${kw.keyword}</span>
                            `).join('')}
                        </div>
                        <div class="platform-preferences">
                            <strong>í”Œë«í¼ ì„ í˜¸ë„:</strong>
                            ${Object.entries(data.platform_preferences).map(([platform, percentage]) => 
                                `${platform}: ${percentage}%`
                            ).join(', ')}
                        </div>
                    `;
                    container.appendChild(ageDiv);
                }
                
            } catch (error) {
                console.error('ì—°ë ¹ëŒ€ë³„ íŠ¸ë Œë“œ ë¶„ì„ ì‹¤íŒ¨:', error);
                document.getElementById('age-trends-results').innerHTML = 
                    '<p class="error">ì—°ë ¹ëŒ€ë³„ íŠ¸ë Œë“œ ë¶„ì„ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
            }
        }
        
        // íŠ¹ì • í‚¤ì›Œë“œ ì—°ë ¹ëŒ€ ë¶„ì„
        async function analyzeSpecificKeyword() {
            const keyword = document.getElementById('keywordForAnalysis').value.trim();
            if (!keyword) {
                alert('ë¶„ì„í•  í‚¤ì›Œë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            try {
                const response = await fetch(`/api/age-analysis/keyword/${encodeURIComponent(keyword)}`);
                const data = await response.json();
                
                const container = document.getElementById('keyword-analysis-results');
                container.innerHTML = `
                    <h3>"${data.keyword}" ì—°ë ¹ëŒ€ë³„ ë¶„ì„</h3>
                    <div class="keyword-summary">
                        <p><strong>ì „ì²´ ì–¸ê¸‰ ìˆ˜:</strong> ${data.total_mentions}</p>
                        <p><strong>íŠ¸ë Œë“œ ë°©í–¥:</strong> ${data.trending_trend}</p>
                        <p><strong>ê°ì • ì ìˆ˜:</strong> ${data.sentiment_score || 'N/A'}</p>
                    </div>
                    
                    <div class="age-groups-analysis">
                        <h4>ì—°ë ¹ëŒ€ë³„ ë¶„ì„</h4>
                        ${Object.entries(data.age_groups).map(([ageGroup, analysis]) => `
                            <div class="age-analysis-item">
                                <h5>${ageGroup}</h5>
                                <p>ì–¸ê¸‰ ìˆ˜: ${analysis.mentions}</p>
                                <p>ê´€ë ¨ì„± ì ìˆ˜: ${analysis.relevance_score}</p>
                                <p>íŠ¸ë Œë”© ë ˆë²¨: ${analysis.trending_level}</p>
                                <p>í”Œë«í¼ ë¶„í¬: ${Object.entries(analysis.platform_mentions).map(([platform, count]) => 
                                    `${platform}: ${count}`
                                ).join(', ')}</p>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="related-keywords">
                        <h4>ê´€ë ¨ í‚¤ì›Œë“œ</h4>
                        ${data.related_keywords.map(kw => `<span class="keyword-tag">${kw}</span>`).join('')}
                    </div>
                `;
                
            } catch (error) {
                console.error('í‚¤ì›Œë“œ ë¶„ì„ ì‹¤íŒ¨:', error);
                document.getElementById('keyword-analysis-results').innerHTML = 
                    '<p class="error">í‚¤ì›Œë“œ ë¶„ì„ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
            }
        }
    </script>
</body>
</html> 