<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>트렌드 키워드 대시보드</title>
    <link rel="stylesheet" href="/static/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <h1>트렌드 키워드 대시보드</h1>
    
    <!-- 실시간 인기 검색어 섹션 -->
    <div class="trending-section">
        <h2>🔥 실시간 인기 검색어</h2>
        <div id="trending-keywords" class="trending-keywords">
            <p>로딩 중...</p>
        </div>
        <button onclick="loadTrendingKeywords()" class="refresh-btn">새로고침</button>
    </div>
    
    <!-- 키워드 입력 폼 -->
    <div class="search-section">
        <h2>🔍 키워드 검색</h2>
        <form method="get" action="/web">
            <input type="text" name="keyword" value="{{ keyword }}" placeholder="키워드를 입력하세요" required>
            <button type="submit">검색</button>
        </form>
    </div>

    <!-- YouTube 트렌드 분석 섹션 -->
    <div class="youtube-analyze-section">
        <h2>🎬 YouTube 트렌드 분석</h2>
        <div class="analyze-panels">
            <div class="panel">
                <h3>채널 핸들명</h3>
                <textarea id="channelHandles" placeholder="@handle 형식, 줄바꿈으로 여러 개 입력"></textarea>
            </div>
            <div class="panel">
                <h3>키워드 입력</h3>
                <textarea id="analyzeKeywords" placeholder="키워드, 줄바꿈으로 여러 개 입력"></textarea>
            </div>
            <div class="panel settings">
                <h3>설정</h3>
                <div class="grid-2">
                    <label>실행모드
                        <select id="mode">
                            <option value="channel">채널</option>
                            <option value="keyword" selected>키워드</option>
                            <option value="both">둘다</option>
                        </select>
                    </label>
                    <label>쇼츠/롱폼
                        <select id="form">
                            <option value="both" selected>둘다</option>
                            <option value="shorts">쇼츠</option>
                            <option value="long">롱폼</option>
                        </select>
                    </label>
                    <label>쇼츠 기준(초)
                        <input id="shortsThreshold" type="number" value="180" min="10">
                    </label>
                    <label>최근 며칠간 분석
                        <input id="timeframeDays" type="number" value="30" min="1">
                    </label>
                    <label>대상국가
                        <input id="region" type="text" value="KR">
                    </label>
                    <label>언어
                        <input id="language" type="text" value="ko">
                    </label>
                    <label>채널당 최대 검색 수
                        <input id="maxPerChannel" type="number" value="10" min="1" max="50">
                    </label>
                    <label>검색어당 최대 검색 수
                        <input id="maxPerKeyword" type="number" value="50" min="1" max="50">
                    </label>
                    <label>최소 조회수
                        <input id="minViewCount" type="number" value="20000" min="0">
                    </label>
                    <label>최소 시간당 조회수
                        <input id="minVph" type="number" value="600" step="0.1" min="0">
                    </label>
                    <label>쿼터 소진시 대기(분)
                        <input id="waitMinutes" type="number" value="30" min="0">
                    </label>
                    <label>API 키 대기 상태
                        <select id="quotaBehavior">
                            <option value="none" selected>대기 중이 아님</option>
                            <option value="skip">대기 스킵 후 다음 키로</option>
                            <option value="wait">대기</option>
                        </select>
                    </label>
                </div>
            </div>
        </div>
        <div class="api-key-row">
            <div>
                <strong>API Key</strong> · YouTube Data API v3 키:
                <input id="ytApiKeyUi" type="password" placeholder="준비중입니다." disabled>
                <small class="muted">(서버의 .env 키 사용 · 준비중입니다.)</small>
            </div>
            <div class="actions">
                <button id="btnStartAnalyze" class="primary" onclick="startAnalyze()">시작하기</button>
                <button onclick="stopAnalyze()">중단하기</button>
                <button onclick="clearAnalyzeResults()">결과 지우기</button>
                <button onclick="exportAnalyzeExcel()">엑셀로 저장</button>
                <button onclick="saveCurrentJob()">현재 작업 저장</button>
                <button onclick="loadSavedJob()">작업 불러오기</button>
                <button onclick="alert('준비중입니다.')">라이선스 관리</button>
            </div>
        </div>

        <div id="analyzeLog" class="analyze-log"></div>

        <div class="results-section" id="analyzeResults" style="display:none;">
            <h3>결과</h3>
            <div class="pager-row">
                <label>페이지 크기
                    <select id="pageSize" onchange="setPageSize(this.value)">
                        <option value="10">10</option>
                        <option value="25" selected>25</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                </label>
                <div class="pager-actions">
                    <button onclick="prevPage()">이전</button>
                    <span id="pageInfo"></span>
                    <button onclick="nextPage()">다음</button>
                </div>
            </div>
            <div class="table-scroll">
                <table id="analyzeTable">
                    <thead>
                        <tr>
                            <th>채널명</th>
                            <th>제목</th>
                            <th>업로드됨</th>
                            <th>조회수</th>
                            <th>시간당 조회수</th>
                            <th>구독자수</th>
                            <th>조회수/구독자수</th>
                            <th>영상 길이</th>
                            <th>영상 링크</th>
                            <th>열기</th>
                            <th>썸네일</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="viewer-row">
                <div class="viewer">
                    <h4>미디어 뷰어</h4>
                    <div id="mediaViewer" class="media-viewer">
                        <p class="muted">영상을 선택하면 이 영역에 표시됩니다.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Google Trends 실시간 인기 검색어 섹션 -->
    <div class="google-trends-section">
        <h2>📊 Google Trends 실시간 인기 검색어</h2>
        <div class="google-trends-controls">
            <select id="regionSelect" onchange="loadGoogleTrends()">
                <option value="KR">한국</option>
                <option value="US">미국</option>
                <option value="JP">일본</option>
                <option value="CN">중국</option>
                <option value="GB">영국</option>
            </select>
            <button onclick="loadGoogleTrends()" class="trends-btn">실시간 인기 검색어</button>
            <button onclick="loadGoogleTrendsByCategory()" class="trends-btn">카테고리별 인기 검색어</button>
            <div class="keyword-input-group">
                <input type="text" id="googleTrendsKeyword" placeholder="키워드 입력">
                <button onclick="analyzeGoogleTrendsKeyword()" class="trends-btn">키워드 분석</button>
            </div>
        </div>
        
        <!-- Google Trends 결과 -->
        <div id="google-trends-results" class="google-trends-results">
            <p>지역을 선택하고 버튼을 클릭하여 Google Trends 데이터를 확인하세요.</p>
        </div>
    </div>
    
    <!-- 연령대별 키워드 분석 섹션 -->
    <div class="age-analysis-section">
        <h2>👥 연령대별 키워드 분석</h2>
        <div class="age-analysis-controls">
            <button onclick="loadAgeGroupKeywords()" class="analysis-btn">연령대별 키워드 분석</button>
            <button onclick="loadAgeGroupTrends()" class="analysis-btn">연령대별 트렌드 분석</button>
            <div class="keyword-input-group">
                <input type="text" id="keywordForAnalysis" placeholder="분석할 키워드 입력">
                <button onclick="analyzeSpecificKeyword()" class="analysis-btn">키워드 연령대 분석</button>
            </div>
        </div>
        
        <!-- 연령대별 키워드 결과 -->
        <div id="age-group-results" class="age-group-results">
            <p>분석 버튼을 클릭하여 연령대별 키워드를 확인하세요.</p>
        </div>
        
        <!-- 연령대별 트렌드 결과 -->
        <div id="age-trends-results" class="age-trends-results">
            <p>분석 버튼을 클릭하여 연령대별 트렌드를 확인하세요.</p>
        </div>
        
        <!-- 특정 키워드 분석 결과 -->
        <div id="keyword-analysis-results" class="keyword-analysis-results">
            <p>키워드를 입력하고 분석 버튼을 클릭하세요.</p>
        </div>
    </div>
    
    {% if error %}
        <div class="error">에러: {{ error }}</div>
    {% endif %}
    
    {% if keyword %}
    <div class="results-section">
        <div class="placeholder-block">
            <img src="/static/coming-soon.png" alt="준비중입니다." class="placeholder-image" onerror="this.style.display='none';document.getElementById('placeholder-text').style.display='block';">
            <p id="placeholder-text" class="placeholder-text">준비중입니다.</p>
        </div>
    </div>
    {% endif %}
    
    <script>
        // 페이지 로드 시 실시간 인기 검색어 로드
        window.onload = function() {
            loadTrendingKeywords();
        };
        
        // 실시간 인기 검색어 로드 함수
        async function loadTrendingKeywords() {
            try {
                const response = await fetch('/api/trends/keywords?max_results=20');
                const data = await response.json();
                
                const container = document.getElementById('trending-keywords');
                container.innerHTML = '';
                
                data.trending_keywords.forEach((item, index) => {
                    const keywordDiv = document.createElement('div');
                    keywordDiv.className = 'keyword-item';
                    keywordDiv.innerHTML = `
                        <span class="rank">${index + 1}</span>
                        <span class="keyword">${item.keyword}</span>
                        <span class="score">🔥 ${item.trending_score}</span>
                        <span class="platforms">${item.platforms.join(', ')}</span>
                        <span class="views">👁️ ${(item.total_views / 1000).toFixed(0)}K</span>
                    `;
                    container.appendChild(keywordDiv);
                });
                
                // 마지막 업데이트 시간 표시
                const updateTime = document.createElement('div');
                updateTime.className = 'update-time';
                updateTime.innerHTML = `마지막 업데이트: ${new Date().toLocaleTimeString()}`;
                container.appendChild(updateTime);
                
            } catch (error) {
                console.error('인기 검색어 로드 실패:', error);
                document.getElementById('trending-keywords').innerHTML = 
                    '<p class="error">인기 검색어를 불러올 수 없습니다.</p>';
            }
        }
        
        // 5분마다 자동 새로고침
        setInterval(loadTrendingKeywords, 5 * 60 * 1000);

        // ------------------ YouTube 분석 ------------------
        let analyzeAbortController = null;
        let analyzeRows = [];
        let currentPage = 1;
        let pageSize = 25;

        function collectAnalyzePayload() {
            // 한글: 폼 값을 수집하여 API 요청 페이로드 구성
            const parseList = (v) => v.split(/\n+/).map(s => s.trim()).filter(Boolean);
            return {
                mode: document.getElementById('mode').value,
                channel_handles: parseList(document.getElementById('channelHandles').value),
                keywords: parseList(document.getElementById('analyzeKeywords').value),
                form: document.getElementById('form').value,
                shorts_threshold_seconds: Number(document.getElementById('shortsThreshold').value || 180),
                timeframe_days: Number(document.getElementById('timeframeDays').value || 30),
                region: document.getElementById('region').value || 'KR',
                language: document.getElementById('language').value || 'ko',
                max_per_channel: Number(document.getElementById('maxPerChannel').value || 10),
                max_per_keyword: Number(document.getElementById('maxPerKeyword').value || 50),
                min_view_count: Number(document.getElementById('minViewCount').value || 20000),
                min_views_per_hour: Number(document.getElementById('minVph').value || 600),
                wait_minutes_on_quota: Number(document.getElementById('waitMinutes').value || 30),
                quota_wait_behavior: document.getElementById('quotaBehavior').value
            };
        }

        async function startAnalyze() {
            try {
                const payload = collectAnalyzePayload();
                const log = document.getElementById('analyzeLog');
                log.innerText = `[${new Date().toLocaleTimeString()}] 시작 | 설정 로드...`;

                analyzeAbortController = new AbortController();
                const resp = await fetch('/api/youtube/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                    signal: analyzeAbortController.signal
                });

                if (!resp.ok) {
                    const errText = await resp.text();
                    log.innerText += `\n[오류] ${errText}`;
                    alert('분석 요청 실패: ' + resp.status);
                    return;
                }

                const data = await resp.json();
                renderAnalyzeResults(data);
                log.innerText += `\n[완료] 총 ${data.total}건 중 ${data.filtered}건 표시`;
            } catch (e) {
                if (e.name === 'AbortError') {
                    document.getElementById('analyzeLog').innerText += `\n[중단] 사용자가 중단했습니다.`;
                } else {
                    document.getElementById('analyzeLog').innerText += `\n[오류] ${e}`;
                }
            }
        }

        function stopAnalyze() {
            if (analyzeAbortController) {
                analyzeAbortController.abort();
            }
        }

        function clearAnalyzeResults() {
            document.querySelector('#analyzeTable tbody').innerHTML = '';
            document.getElementById('analyzeResults').style.display = 'none';
            document.getElementById('analyzeLog').innerText = '';
            document.getElementById('mediaViewer').innerHTML = '<p class="muted">영상을 선택하면 이 영역에 표시됩니다.</p>';
            analyzeRows = [];
            currentPage = 1;
        }

        function renderAnalyzeResults(data) {
            analyzeRows = data.rows || [];
            currentPage = 1;
            renderAnalyzePage();
            document.getElementById('analyzeResults').style.display = '';
        }

        function renderAnalyzePage() {
            const tbody = document.querySelector('#analyzeTable tbody');
            tbody.innerHTML = '';
            const total = analyzeRows.length;
            const start = (currentPage - 1) * pageSize;
            const end = Math.min(start + pageSize, total);
            for (let i = start; i < end; i++) {
                const row = analyzeRows[i];
                const ratio = row.view_to_subscriber_ratio == null ? '' : Number(row.view_to_subscriber_ratio).toFixed(2);
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row.channel_name || ''}</td>
                    <td>${escapeHtml(row.title || '')}</td>
                    <td>${row.published_at ? new Date(row.published_at).toLocaleString() : ''}</td>
                    <td>${fmtNum(row.view_count)}</td>
                    <td>${fmtNum(row.views_per_hour)}</td>
                    <td>${fmtNum(row.subscriber_count)}</td>
                    <td>${ratio}</td>
                    <td>${row.duration || ''}</td>
                    <td><a href="${row.video_url}" onclick="showVideo('${encodeURIComponentForAttr('${' + 'row.video_url' + '}')}'); return false;">링크</a></td>
                    <td><button onclick="showVideo('${escapeJs(row.video_url)}')">영상 열기</button></td>
                    <td>${row.thumbnail_url ? `<button onclick=\"showThumb('${escapeJs(row.thumbnail_url)}')\">썸네일 열기</button>` : ''}</td>
                `;
                tbody.appendChild(tr);
            }
            const pageInfo = document.getElementById('pageInfo');
            const totalPages = Math.max(1, Math.ceil(total / pageSize));
            pageInfo.textContent = `${currentPage} / ${totalPages} (총 ${fmtNum(total)}건)`;
        }

        function setPageSize(v) { pageSize = Number(v||25); currentPage = 1; renderAnalyzePage(); }
        function prevPage() { if (currentPage > 1) { currentPage--; renderAnalyzePage(); } }
        function nextPage() { const totalPages = Math.max(1, Math.ceil((analyzeRows.length||0)/pageSize)); if (currentPage < totalPages) { currentPage++; renderAnalyzePage(); } }

        function showVideo(url) {
            if (!url) return;
            const viewer = document.getElementById('mediaViewer');
            const safe = escapeHtml(url);
            viewer.innerHTML = `<video controls src="${safe}" style="max-width:100%;height:auto"></video>`;
            // YouTube 링크인 경우 iframe으로 처리
            if (/youtube\.com|youtu\.be/.test(url)) {
                const vid = extractYouTubeId(url);
                if (vid) viewer.innerHTML = `<iframe width="560" height="315" src="https://www.youtube.com/embed/${vid}" frameborder="0" allowfullscreen></iframe>`;
            }
        }

        function showThumb(url) {
            if (!url) return;
            const viewer = document.getElementById('mediaViewer');
            const safe = escapeHtml(url);
            viewer.innerHTML = `<img src="${safe}" alt="thumbnail" style="max-width:100%;height:auto" />`;
        }

        function extractYouTubeId(u){
            try {
                const m = String(u).match(/[?&]v=([^&#]+)/) || String(u).match(/youtu\.be\/([^?&#]+)/);
                return m ? m[1] : '';
            } catch { return ''; }
        }

        function exportAnalyzeExcel() {
            const payload = collectAnalyzePayload();
            const a = document.createElement('a');
            a.href = '/api/youtube/analyze/export';
            // POST로 보내야 하므로 fetch 후 blob 다운로드
            fetch('/api/youtube/analyze/export', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            }).then(r => {
                if (!r.ok) throw new Error('엑셀 요청 실패');
                return r.blob();
            }).then(blob => {
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'youtube_analysis.xlsx';
                document.body.appendChild(link);
                link.click();
                link.remove();
                URL.revokeObjectURL(url);
            }).catch(err => alert(err));
        }

        function saveCurrentJob() {
            try {
                const key = 'yt_analyze_job_v1';
                localStorage.setItem(key, JSON.stringify(collectAnalyzePayload()));
                alert('현재 작업 저장 완료');
            } catch (e) { alert('저장 실패'); }
        }

        function loadSavedJob() {
            try {
                const key = 'yt_analyze_job_v1';
                const data = JSON.parse(localStorage.getItem(key) || '{}');
                if (!Object.keys(data).length) { alert('저장된 작업이 없습니다.'); return; }
                // 한글: 각 필드 채우기
                document.getElementById('mode').value = data.mode || 'keyword';
                document.getElementById('form').value = data.form || 'both';
                document.getElementById('shortsThreshold').value = data.shorts_threshold_seconds ?? 180;
                document.getElementById('timeframeDays').value = data.timeframe_days ?? 30;
                document.getElementById('region').value = data.region || 'KR';
                document.getElementById('language').value = data.language || 'ko';
                document.getElementById('maxPerChannel').value = data.max_per_channel ?? 10;
                document.getElementById('maxPerKeyword').value = data.max_per_keyword ?? 50;
                document.getElementById('minViewCount').value = data.min_view_count ?? 20000;
                document.getElementById('minVph').value = data.min_views_per_hour ?? 600;
                document.getElementById('waitMinutes').value = data.wait_minutes_on_quota ?? 30;
                document.getElementById('quotaBehavior').value = data.quota_wait_behavior || 'none';
                document.getElementById('channelHandles').value = (data.channel_handles || []).join('\n');
                document.getElementById('analyzeKeywords').value = (data.keywords || []).join('\n');
                alert('작업 불러오기 완료');
            } catch (e) { alert('불러오기 실패'); }
        }

        function fmtNum(v){ return (v===null||v===undefined||Number.isNaN(v))?'': new Intl.NumberFormat().format(v); }
        function escapeHtml(str){ return (str||'').replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[s])); }
        function escapeJs(str){ return String(str||'').replace(/['"\\]/g, m => ({"'":"\\'","\"":"\\\"","\\":"\\\\"}[m])); }
        
        // Google Trends 실시간 인기 검색어 로드
        async function loadGoogleTrends() {
            const region = document.getElementById('regionSelect').value;
            try {
                const response = await fetch(`/api/google-trends/realtime?region=${region}`);
                const data = await response.json();
                
                const container = document.getElementById('google-trends-results');
                container.innerHTML = `
                    <h3>🌍 ${getRegionName(region)} 실시간 인기 검색어</h3>
                    <div class="trending-list">
                        ${data.trending_searches.map((item, index) => `
                            <div class="trending-item">
                                <span class="rank">${item.rank}</span>
                                <span class="keyword">${item.keyword}</span>
                                <span class="source">${item.source}</span>
                            </div>
                        `).join('')}
                    </div>
                    <p class="update-time">마지막 업데이트: ${new Date().toLocaleTimeString()}</p>
                `;
                
            } catch (error) {
                console.error('Google Trends 로드 실패:', error);
                document.getElementById('google-trends-results').innerHTML = 
                    '<p class="error">Google Trends 데이터를 불러올 수 없습니다.</p>';
            }
        }
        
        // Google Trends 카테고리별 인기 검색어 로드
        async function loadGoogleTrendsByCategory() {
            const region = document.getElementById('regionSelect').value;
            const categories = ['entertainment', 'business', 'sports', 'health', 'science_tech'];
            
            try {
                const container = document.getElementById('google-trends-results');
                container.innerHTML = '<h3>📂 카테고리별 인기 검색어</h3>';
                
                for (const category of categories) {
                    const response = await fetch(`/api/google-trends/category/${category}?region=${region}`);
                    const data = await response.json();
                    
                    const categoryDiv = document.createElement('div');
                    categoryDiv.className = 'category-trends';
                    categoryDiv.innerHTML = `
                        <h4>${getCategoryName(category)}</h4>
                        <div class="trending-list">
                            ${data.trending_searches.slice(0, 5).map((item, index) => `
                                <div class="trending-item">
                                    <span class="rank">${item.rank}</span>
                                    <span class="keyword">${item.keyword}</span>
                                </div>
                            `).join('')}
                        </div>
                    `;
                    container.appendChild(categoryDiv);
                }
                
            } catch (error) {
                console.error('카테고리별 Google Trends 로드 실패:', error);
                document.getElementById('google-trends-results').innerHTML = 
                    '<p class="error">카테고리별 데이터를 불러올 수 없습니다.</p>';
            }
        }
        
        // Google Trends 키워드 분석
        async function analyzeGoogleTrendsKeyword() {
            const keyword = document.getElementById('googleTrendsKeyword').value.trim();
            const region = document.getElementById('regionSelect').value;
            
            if (!keyword) {
                alert('분석할 키워드를 입력해주세요.');
                return;
            }
            
            try {
                const container = document.getElementById('google-trends-results');
                container.innerHTML = '<h3>🔍 키워드 분석 중...</h3>';
                
                // 여러 API 호출
                const [interestData, relatedData, regionData, ageData] = await Promise.all([
                    fetch(`/api/google-trends/keyword/${encodeURIComponent(keyword)}/interest?region=${region}`).then(r => r.json()),
                    fetch(`/api/google-trends/keyword/${encodeURIComponent(keyword)}/related?region=${region}`).then(r => r.json()),
                    fetch(`/api/google-trends/keyword/${encodeURIComponent(keyword)}/regions?region=${region}`).then(r => r.json()),
                    fetch(`/api/google-trends/keyword/${encodeURIComponent(keyword)}/age-groups?region=${region}`).then(r => r.json())
                ]);
                
                container.innerHTML = `
                    <h3>"${keyword}" Google Trends 분석</h3>
                    
                    <div class="analysis-section">
                        <h4>📈 관심도 추이</h4>
                        <p>평균 관심도: ${interestData.average_interest}/100</p>
                        <p>최대 관심도: ${interestData.max_interest}/100</p>
                        <p>데이터 소스: ${interestData.source}</p>
                    </div>
                    
                    <div class="analysis-section">
                        <h4>🔗 관련 검색어</h4>
                        <div class="related-queries">
                            <h5>상위 관련 검색어:</h5>
                            ${relatedData.top_queries.map(q => `<span class="query-tag">${q.query} (${q.value})</span>`).join('')}
                        </div>
                        <div class="related-queries">
                            <h5>급상승 관련 검색어:</h5>
                            ${relatedData.rising_queries.map(q => `<span class="query-tag rising">${q.query} (${q.value})</span>`).join('')}
                        </div>
                    </div>
                    
                    <div class="analysis-section">
                        <h4>🌍 지역별 관심도</h4>
                        <div class="region-interest">
                            ${regionData.regions.slice(0, 5).map(r => `
                                <div class="region-item">
                                    <span class="region-name">${r.region}</span>
                                    <span class="interest-score">${r.interest}/100</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div class="analysis-section">
                        <h4>👥 연령대별 관심도 (추정)</h4>
                        <div class="age-interest">
                            ${ageData.age_groups.map(age => `
                                <div class="age-item">
                                    <span class="age-group">${age.age_group}</span>
                                    <span class="interest-score">${age.interest}/100</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                
            } catch (error) {
                console.error('Google Trends 키워드 분석 실패:', error);
                document.getElementById('google-trends-results').innerHTML = 
                    '<p class="error">키워드 분석을 불러올 수 없습니다.</p>';
            }
        }
        
        // 지역명 변환
        function getRegionName(region) {
            const regionNames = {
                'KR': '한국', 'US': '미국', 'JP': '일본', 'CN': '중국', 'GB': '영국'
            };
            return regionNames[region] || region;
        }
        
        // 카테고리명 변환
        function getCategoryName(category) {
            const categoryNames = {
                'entertainment': '엔터테인먼트',
                'business': '비즈니스',
                'sports': '스포츠',
                'health': '건강',
                'science_tech': '과학기술'
            };
            return categoryNames[category] || category;
        }
        
        // 연령대별 키워드 분석 로드
        async function loadAgeGroupKeywords() {
            try {
                const response = await fetch('/api/age-analysis/keywords?max_results=15');
                const data = await response.json();
                
                const container = document.getElementById('age-group-results');
                container.innerHTML = '<h3>연령대별 인기 키워드</h3>';
                
                data.forEach(ageGroup => {
                    const ageDiv = document.createElement('div');
                    ageDiv.className = 'age-group';
                    ageDiv.innerHTML = `
                        <h4>${ageGroup.age_group} (트렌딩 점수: ${ageGroup.trending_score})</h4>
                        <div class="keywords-list">
                            ${ageGroup.keywords.map((kw, index) => `
                                <span class="keyword-tag ${kw.trending_level.replace(/\s+/g, '-').toLowerCase()}">
                                    ${index + 1}. ${kw.keyword} (${kw.score})
                                </span>
                            `).join('')}
                        </div>
                        <div class="platform-distribution">
                            <strong>플랫폼 분포:</strong> 
                            ${Object.entries(ageGroup.platform_distribution).map(([platform, count]) => 
                                `${platform}: ${count}`
                            ).join(', ')}
                        </div>
                    `;
                    container.appendChild(ageDiv);
                });
                
            } catch (error) {
                console.error('연령대별 키워드 분석 실패:', error);
                document.getElementById('age-group-results').innerHTML = 
                    '<p class="error">연령대별 키워드 분석을 불러올 수 없습니다.</p>';
            }
        }
        
        // 연령대별 트렌드 분석 로드
        async function loadAgeGroupTrends() {
            try {
                const ageGroups = ['10대', '20대', '30대', '40대', '50대+'];
                const container = document.getElementById('age-trends-results');
                container.innerHTML = '<h3>연령대별 트렌드 분석</h3>';
                
                for (const ageGroup of ageGroups) {
                    const response = await fetch(`/api/age-analysis/trends/${encodeURIComponent(ageGroup)}?max_results=10`);
                    const data = await response.json();
                    
                    const ageDiv = document.createElement('div');
                    ageDiv.className = 'age-trends';
                    ageDiv.innerHTML = `
                        <h4>${data.age_group} 트렌드</h4>
                        <div class="top-keywords">
                            <strong>상위 키워드:</strong>
                            ${data.top_keywords.map((kw, index) => `
                                <span class="keyword-tag">${index + 1}. ${kw.keyword}</span>
                            `).join('')}
                        </div>
                        <div class="platform-preferences">
                            <strong>플랫폼 선호도:</strong>
                            ${Object.entries(data.platform_preferences).map(([platform, percentage]) => 
                                `${platform}: ${percentage}%`
                            ).join(', ')}
                        </div>
                    `;
                    container.appendChild(ageDiv);
                }
                
            } catch (error) {
                console.error('연령대별 트렌드 분석 실패:', error);
                document.getElementById('age-trends-results').innerHTML = 
                    '<p class="error">연령대별 트렌드 분석을 불러올 수 없습니다.</p>';
            }
        }
        
        // 특정 키워드 연령대 분석
        async function analyzeSpecificKeyword() {
            const keyword = document.getElementById('keywordForAnalysis').value.trim();
            if (!keyword) {
                alert('분석할 키워드를 입력해주세요.');
                return;
            }
            
            try {
                const response = await fetch(`/api/age-analysis/keyword/${encodeURIComponent(keyword)}`);
                const data = await response.json();
                
                const container = document.getElementById('keyword-analysis-results');
                container.innerHTML = `
                    <h3>"${data.keyword}" 연령대별 분석</h3>
                    <div class="keyword-summary">
                        <p><strong>전체 언급 수:</strong> ${data.total_mentions}</p>
                        <p><strong>트렌드 방향:</strong> ${data.trending_trend}</p>
                        <p><strong>감정 점수:</strong> ${data.sentiment_score || 'N/A'}</p>
                    </div>
                    
                    <div class="age-groups-analysis">
                        <h4>연령대별 분석</h4>
                        ${Object.entries(data.age_groups).map(([ageGroup, analysis]) => `
                            <div class="age-analysis-item">
                                <h5>${ageGroup}</h5>
                                <p>언급 수: ${analysis.mentions}</p>
                                <p>관련성 점수: ${analysis.relevance_score}</p>
                                <p>트렌딩 레벨: ${analysis.trending_level}</p>
                                <p>플랫폼 분포: ${Object.entries(analysis.platform_mentions).map(([platform, count]) => 
                                    `${platform}: ${count}`
                                ).join(', ')}</p>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="related-keywords">
                        <h4>관련 키워드</h4>
                        ${data.related_keywords.map(kw => `<span class="keyword-tag">${kw}</span>`).join('')}
                    </div>
                `;
                
            } catch (error) {
                console.error('키워드 분석 실패:', error);
                document.getElementById('keyword-analysis-results').innerHTML = 
                    '<p class="error">키워드 분석을 불러올 수 없습니다.</p>';
            }
        }
    </script>
</body>
</html> 